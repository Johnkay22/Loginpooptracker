<!DOCTYPE html><html><head>
 <script async src="https://www.googletagmanager.com/gtag/js?id=G-R1E17DCKNC"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-R1E17DCKNC');
</script>   
<base href="https://poopprofit.com/">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Poop Profit: Your Ultimate Bathroom Companion</title>
<style>
    :root {
        --primary-color: #1a1a2e;
        --secondary-color: #16213e;
        --accent-color: #0f3460;
        --text-color: #00CED1;
        --light-text: #f1f1f1;
        --neon-blue: #3498db;
        --light-grey: #e0e0e0;
    }

    body {
        background-image: url('https://www.poopprofit.com/MAINDESKTOPBG.jpeg');
        background-size: cover;
        background-position: center;
        background-attachment: fixed;
        background-repeat: no-repeat;
        color: var(--light-text);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
    }

    * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
        font-family: 'Roboto', sans-serif;
    }

    .app-container {
        background-color: rgba(26, 26, 46, 0.8);
        border-radius: 10px;
        padding: 20px;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        padding-top: 60px;
    }

    header {
        position: relative;
        width: 100%;
        padding: 0;
        margin-bottom: 0.5rem;
        overflow: hidden;
        border-radius: 10px;
    }

    .header-image {
        width: 100%;
        height: auto;
        display: block;
    }

    .turd-token-balance {
        position: fixed;
        top: 20px;
        right: 10px;
        transform: none;
        z-index: 1000;
        font-size: 1.2em;
        padding: 10px;
        background-color: rgba(22, 33, 62, 0.9);
        border-radius: 10px;
        display: flex;
        align-items: center;
        cursor: pointer;
    }

    .turd-token-icon {
        width: 30px;
        height: 30px;
        margin-right: 5px;
    }

    main {
        flex: 1;
        display: flex;
        flex-direction: column;
    }

    .interface-container {
        display: flex;
        flex-direction: column;
    }

    .tabs {
        display: flex;
        justify-content: space-evenly;
        align-items: center;
        width: 100%;
        background-color: rgba(22, 33, 62, 0.9);
        padding: 20px 0;
        border-radius: 10px 10px 0 0;
        position: relative;
    }

    .tab {
        padding: 15px;
        background-color: transparent;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        border-bottom: 4px solid transparent;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    .tab.active {
        background-color: var(--primary-color);
        border-bottom: 4px solid var(--neon-blue);
    }

    .tab:hover {
        background-color: var(--accent-color);
    }

    .tab-icon {
        width: 60px;
        height: 60px;
        transition: transform 0.3s ease;
    }

    @media (min-width: 768px) {
        .tab-icon {
            width: 80px;  
            height: 80px;
        }

        .tab {
            padding: 20px;
        }
    }

    .tab:hover .tab-icon {
        transform: scale(1.1);
    }

    .tab-content-container {
        flex: 1;
        background-color: rgba(26, 26, 46, 0.9);
        border-radius: 0 10px 10px 0;
        padding: 20px;
    }

    .tab-content {
        display: none;
        background-color: var(--primary-color);
        border: none;
        border-radius: 0;
        padding: 0;
        transition: opacity 0.3s ease-in-out;
        opacity: 1;
    }

    .tab-content.active {
        display: block;
    }

    .tab-content.fade-out {
        opacity: 0;
    }

    .calculator-container {
        background-color: transparent;
        box-shadow: none;
        padding: 0;
    }

    .calculator-title {
        font-size: 2.5rem;
        font-weight: bold;
        text-align: center;
        margin-bottom: 1rem;
        color: var(--neon-blue);
        text-shadow: 0 0 10px var(--neon-blue), 0 0 20px var(--neon-blue), 0 0 30px var(--neon-blue);
    }

    .calculator-description {
        font-size: 1.2rem;
        text-align: center;
        color: var(--light-grey);
        margin-bottom: 2rem;
    }

    .input-section {
        display: flex;
        justify-content: space-between;
        margin-bottom: 2rem;
    }

    .wage-input-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .toggle-container {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
    }

    .switch {
        position: relative;
        display: inline-block;
        width: 60px;
        height: 34px;
        margin-right: 15px;
    }

    .switch input {
        opacity: 0;
        width: 0;
        height: 0;
    }

    .slider {
        position: absolute;
        cursor: pointer;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--accent-color);
        transition: .4s;
        border-radius: 34px;
    }

    .slider:before {
        position: absolute;
        content: "";
        height: 26px;
        width: 26px;
        left: 4px;
        bottom: 4px;
        background-color: white;
        transition: .4s;
        border-radius: 50%;
    }

    input:checked + .slider {
        background-color: var(--neon-blue);
    }

    input:checked + .slider:before {
        transform: translateX(26px);
    }

    #toggleLabel {
        font-size: 1rem;
        color: var(--light-text);
    }

    .input-group {
        margin-bottom: 15px;
    }

    .input-label {
        display: block;
        margin-bottom: 5px;
        color: var(--light-grey);
        font-size: 0.9rem;
    }

    .input-field {
        width: 100%;
        padding: 10px;
        border: 1px solid var(--accent-color);
        border-radius: 5px;
        background-color: var(--secondary-color);
        color: var(--light-text);
        font-size: 1rem;
        transition: border-color 0.3s ease;
    }

    .input-field:focus {
        outline: none;
        border-color: var(--neon-blue);
        box-shadow: 0 0 5px rgba(52, 152, 219, 0.5);
    }

    .error-message {
        color: #ff4d4d;
        font-size: 0.8rem;
        margin-top: 5px;
        display: none;
    }

    @media (min-width: 768px) {
        #salaryHoursInputs, #hourlyWageInput {
            display: flex;
            gap: 20px;
        }

        .input-group {
            flex: 1;
        }
    }

    .hourly-wage {
        text-align: center;
        font-size: 1.2rem;
        margin-top: 1rem;
        color: var(--text-color);
    }

    .timer-section {
        text-align: center;
        margin-bottom: 2rem;
    }

    .poop-emoji {
        font-size: 3rem;
        margin-bottom: 1rem;
    }

    .poop-emoji.wiggle {
        animation: wiggle 0.5s infinite;
    }

    .timer-display {
        font-size: 3rem;
        font-weight: bold;
        color: var(--text-color);
        margin-bottom: 1rem;
    }

    .timer-button {
        padding: 15px 30px;
        font-size: 1.2rem;
        border: none;
        border-radius: 50px;
        background-color: var(--neon-blue);
        color: white;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .timer-button:hover {
        transform: scale(1.05);
        box-shadow: 0 0 15px var(--neon-blue);
    }

    .earnings-display {
        font-size: 1.2rem;
        color: var(--text-color);
        margin-top: 1rem;
        font-weight: bold;
    }

    .poop-log-section {
        text-align: center;
        max-height: 300px;
        overflow-y: auto;
    }

    .poop-log-title {
        font-size: 1.5rem;
        color: var(--light-grey);
        margin-bottom: 1rem;
    }

    .poop-log-placeholder {
        color: var(--light-grey);
        font-style: italic;
    }

    .log-entry {
        background-color: var(--secondary-color);
        border-radius: 10px;
        padding: 10px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        position: relative;
    }

    .log-entry p {
        margin: 5px 0;
    }

    .log-entry .log-date {
        font-weight: bold;
        color: var(--neon-blue);
    }

    .log-entry .log-duration,
    .log-entry .log-earnings,
    .log-entry .log-rating {
        color: var(--light-grey);
    }

    .delete-button {
        position: absolute;
        top: 5px;
        right: 5px;
        background-color: #ff4d4d;
        color: white;
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        font-size: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .delete-button:hover {
        background-color: #ff1a1a;
    }

    .card {
        background-color: rgba(22, 33, 62, 0.8);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 2rem;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        transition: all 0.3s ease;
    }

    .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
    }

    @keyframes wiggle {
        0% { transform: rotate(0deg); }
        25% { transform: rotate(-5deg); }
        75% { transform: rotate(5deg); }
        100% { transform: rotate(0deg); }
    }

    @media (max-width: 767px) {
        .tabs {
            flex-wrap: wrap;
        }

        .tab {
            flex: 1 0 25%;
            max-width: 25%;
        }

        .turd-token-balance {
            position: fixed;
            top: 10px;
            right: 10px;
            width: auto;
        }
    }

    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.4);
    }

    .modal-content {
        background-color: var(--secondary-color);
        margin: 15% auto;
        padding: 20px;
        border: 1px solid var(--accent-color);
        width: 300px;
        border-radius: 10px;
        text-align: center;
    }

    .emoji-rating {
        font-size: 2rem;
        margin: 20px 0;
    }

    .poopEmoji {
        cursor: pointer;
        opacity: 0.5;
        transition: opacity 0.3s ease;
    }

    .poopEmoji:hover {
        opacity: 1;
    }

    #submitRatingButton {
        padding: 10px 20px;
        background-color: var(--neon-blue);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    #submitRatingButton:hover {
        background-color: #2980b9;
    }

    .congrats-message {
        color: #4CAF50;
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 1.1em;
    }

    #shareModal .modal-content {
        width: 400px;
    }

    #shareModal button {
        display: block;
        width: 100%;
        padding: 10px;
        margin-top: 10px;
        background-color: var(--neon-blue);
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.3s ease;
    }

    #shareModal button:hover {
        background-color: #2980b9;
    }

    #twitterShareButton {
        background-color: #1DA1F2;
    }

    #facebookShareButton {
        background-color: #4267B2;
    }

    #smsShareButton {
        background-color: #25D366;
    }

    #statisticsSection {
        margin-bottom: 20px;
    }

    .statistics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
        background: rgba(26, 26, 46, 0.4);
        padding: 20px;
        border-radius: 15px;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(52, 152, 219, 0.2);
    }

    .stat-card {
        background: linear-gradient(145deg, rgba(22, 33, 62, 0.9), rgba(15, 52, 96, 0.9));
        border-radius: 15px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .stat-card:before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: linear-gradient(
            45deg,
            transparent,
            rgba(52, 152, 219, 0.1),
            transparent
        );
        transform: rotate(45deg);
        animation: shine 3s infinite;
    }

    .stat-card.featured {
        background: linear-gradient(145deg, rgba(52, 152, 219, 0.2), rgba(41, 128, 185, 0.2));
        border: 2px solid rgba(52, 152, 219, 0.5);
        padding: 30px;
    }

    .stat-card.featured p {
        font-size: 3.5rem;
        background: linear-gradient(45deg, #3498db, #2ecc71);
        -webkit-background-clip: text;
        background-clip: text;
        -webkit-text-fill-color: transparent;
        text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        margin-bottom: 10px;
    }

    .stat-card:not(.featured) p {
        font-size: 1.8rem;
        color: var(--text-color);
        text-shadow: 0 0 10px rgba(0, 206, 209, 0.5);
        margin-bottom: 5px;
    }

    .stat-card span {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    @keyframes shine {
        0% {
            left: -100%;
        }
        20% {
            left: 100%;
        }
        100% {
            left: 100%;
        }
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3), 
                    0 0 15px rgba(52, 152, 219, 0.5);
    }

    #statsChart {
        background: rgba(26, 26, 46, 0.8);
        border-radius: 15px;
        padding: 20px;
        border: 1px solid rgba(52, 152, 219, 0.2);
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        backdrop-filter: blur(4px);
    }

    .date-range-controls {
        background: linear-gradient(145deg, rgba(22, 33, 62, 0.9), rgba(15, 52, 96, 0.9));
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 30px;
        box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        border: 1px solid rgba(52, 152, 219, 0.2);
        backdrop-filter: blur(10px);
        display: flex;
        gap: 15px;
        align-items: center;
        flex-wrap: wrap;
    }

    .quick-filter-btn {
        background: linear-gradient(145deg, rgba(22, 33, 62, 0.9), rgba(15, 52, 96, 0.9));
        border: 1px solid rgba(52, 152, 219, 0.3);
        padding: 12px 24px;
        border-radius: 10px;
        color: var(--light-text);
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    .quick-filter-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
        border-color: rgba(52, 152, 219, 0.6);
    }

    .quick-filter-btn.active {
        background: linear-gradient(145deg, var(--neon-blue), #2980b9);
        border-color: var(--neon-blue);
        box-shadow: 0 0 15px rgba(52, 152, 219, 0.5);
    }

    #startDate, #endDate {
        background: linear-gradient(145deg, rgba(22, 33, 62, 0.9), rgba(15, 52, 96, 0.9));
        border: 1px solid rgba(52, 152, 219, 0.3);
        border-radius: 10px;
        padding: 12px;
        color: var(--light-text);
        transition: all 0.3s ease;
    }

    #startDate:focus, #endDate:focus {
        outline: none;
        border-color: var(--neon-blue);
        box-shadow: 0 0 15px rgba(52, 152, 219, 0.3);
    }

    #filterStats, #resetStats {
        background: linear-gradient(145deg, rgba(22, 33, 62, 0.9), rgba(15, 52, 96, 0.9));
        border: 1px solid rgba(52, 152, 219, 0.3);
        border-radius: 10px;
        padding: 12px 24px;
        color: var(--light-text);
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    #filterStats {
        background: linear-gradient(145deg, var(--neon-blue), #2980b9);
    }

    #filterStats:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }

    #resetStats {
        background: linear-gradient(145deg, #e74c3c, #c0392b);
        border-color: #e74c3c;
    }

    #resetStats:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
    }

    .date-range-divider {
        color: var(--light-text);
        opacity: 0.7;
        font-size: 0.9em;
    }

    .date-range-header {
        color: var(--light-text);
        font-size: 1.2em;
        margin-bottom: 15px;
        text-transform: uppercase;
        letter-spacing: 1px;
        text-shadow: 0 0 10px rgba(52, 152, 219, 0.5);
    }

    .game-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        padding: 20px;
    }

    .game-link {
        display: block;
        text-align: center;
    }

    .game-image {
        max-width: 100%;
        height: auto;
        border-radius: 10px;
        transition: transform 0.3s ease;
    }

    .game-image:hover {
        transform: scale(1.05);
    }

    .confirm-dialog {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 1000;
    }

    .confirm-dialog-content {
        background-color: var(--secondary-color);
        border-radius: 10px;
        padding: 20px;
        width: 300px;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
    }

    .confirm-dialog-buttons {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-top: 20px;
    }

    .confirm-dialog button {
        padding: 10px 20px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .confirm-dialog .confirm {
        background-color: #ff4d4d;
        color: white;
    }

    .confirm-dialog .cancel {
        background-color: var(--neon-blue);
        color: white;
    }

    .confirm-dialog button:hover {
        transform: translateY(-2px);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
    }
 .popup {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.8);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000;
}

.popup-content {
    background-color: #000;
    border: 1px solid #00ffff;
    padding: 20px;
    border-radius: 8px;
    width: 80%;
    max-width: 400px;
    text-align: center;
    color: #00ffff;
}

.close-btn {
    color: #00ffff;
    float: right;
    font-size: 1.5em;
    cursor: pointer;
    margin-top: -10px;
}

    .logout-btn {
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 10px 20px;
    background: linear-gradient(145deg, var(--secondary-color), var(--accent-color));
    color: var(--light-text);
    border: 1px solid rgba(52, 152, 219, 0.3);
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s ease;
    font-size: 14px;
    z-index: 1000;
}

.logout-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    background: linear-gradient(145deg, var(--accent-color), var(--neon-blue));
}

    /* Container for share buttons */
.share-statistics {
    margin-top: 20px;
    display: flex;
    justify-content: center;
    gap: 20px;
}

/* Base style for each share button */
.share-button {
    background-color: var(--secondary-color); /* Customizable background color */
    border: none;
    border-radius: 75%; /* Circular button style */
    width: 75px; /* Button size */
    height: 75px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    overflow: hidden;
}

/* Style for the custom icons within buttons */
.share-button img {
    width: 72px;
    height: 72px;
}

/* Hover effects for each specific button */
.share-button.twitter:hover {
    background-color: #1DA1F2; /* Twitter blue */
}

.share-button.facebook:hover {
    background-color: #4267B2; /* Facebook blue */
}

.share-button.sms:hover {
    background-color: #25D366; /* SMS green */
}

/* Optional: Additional hover animation and shadow */
.share-button:hover {
    transform: scale(1.1); /* Slightly enlarges button on hover */
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
}
    /* Ensure game and shop images are visible */
    .game-image, .shop-image {
        display: block !important;
        visibility: visible !important;
    }
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
let currentUser = null;
let annualSalaryInput;
let weeklyHoursInput;
let wageToggle;
let hourlyWageField;
let hourlyWageDisplay;
let hourlyWage = 0;

// NEW: Store logs as data objects, not HTML strings
let poopLogData = []; 

let stats = {
    totalSessions: 0,
    totalPoopTime: 0,
    totalEarnings: 0,
    firstSessionDate: null,
    lastSessionDate: null
};

let turdTokens = 0;
let lastAwardDate = null;

let isTimerRunning = false;

function formatTime(totalSeconds) {
    const hours = Math.floor(totalSeconds / 3600);
    const minutes = Math.floor((totalSeconds % 3600) / 60);
    const seconds = totalSeconds % 60;
    return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
}

function updateHourlyWage() {
    if (wageToggle && wageToggle.checked) {
        hourlyWage = parseFloat(hourlyWageField.value) || 0;
    } else if (annualSalaryInput && weeklyHoursInput) {
        const annualSalary = parseFloat(annualSalaryInput.value) || 0;
        const weeklyHours = parseFloat(weeklyHoursInput.value) || 0;
        
        if (weeklyHours > 0) {
            hourlyWage = (annualSalary / 52) / weeklyHours;
        } else {
            hourlyWage = 0;
        }
    }
    if (hourlyWageDisplay) {
        hourlyWageDisplay.textContent = `Your hourly wage: $${hourlyWage.toFixed(2)}`;
    }
    saveUserData();
}

function loadUserData() {
    try {
        const savedUser = JSON.parse(localStorage.getItem('currentUser'));
        const userData = savedUser?.data || savedUser;

        if (userData) {
            hourlyWage = userData.hourlyWage || 0;
            if(annualSalaryInput) annualSalaryInput.value = userData.annualSalary || '';
            if(weeklyHoursInput) weeklyHoursInput.value = userData.weeklyHours || '';
            if(hourlyWageField) hourlyWageField.value = userData.hourlyWageInput || '';
            if(wageToggle) wageToggle.checked = userData.wageToggle || false;
            turdTokens = userData.turdTokens || 0;
            lastAwardDate = userData.lastAwardDate || null;

            // Initialize or Migrate data
            if (userData.poopLogData) {
                poopLogData = userData.poopLogData;
            } else if (userData.poopLogs && userData.poopLogs.length > 0) {
                try {
                    migrateOldData(userData.poopLogs);
                } catch (e) {
                    console.error("Migration failed, starting fresh", e);
                    poopLogData = [];
                }
            } else {
                poopLogData = [];
            }

            renderPoopLogs();
            recalculateStatistics(); 
            updateTurdTokenDisplay();
            updateHourlyWage();
        }
    } catch (e) {
        console.error("Error loading user data:", e);
    }
}

function migrateOldData(oldHtmlLogs) {
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = oldHtmlLogs.join('');
    
    poopLogData = Array.from(tempDiv.children).map((entry, index) => {
        // Safe navigation to avoid crashes on malformed logs
        const dateText = entry.querySelector('.log-date')?.textContent || new Date().toLocaleString();
        const durationText = entry.querySelector('.log-duration')?.textContent || "00:00:00";
        const earningsText = entry.querySelector('.log-earnings')?.textContent || "$0.00";
        const ratingElement = entry.querySelector('.rating-value');
        const ratingText = ratingElement ? ratingElement.textContent : "";

        const [hours, minutes, seconds] = (durationText.match(/\d+/g) || [0,0,0]).map(Number);
        const totalSeconds = (hours * 3600) + (minutes * 60) + seconds;
        
        const ratingCount = (ratingText.match(/ðŸ’©/g) || []).length;

        return {
            id: Date.now() + index, 
            date: dateText,
            durationSeconds: totalSeconds,
            earnings: parseFloat(earningsText.replace(/[^0-9.-]+/g, '') || 0),
            rating: ratingCount
        };
    });
}

function standardizeUsersFormat() {
    try {
        const users = JSON.parse(localStorage.getItem('users') || '{}');
        Object.keys(users).forEach(email => {
            if (typeof users[email] === 'string') {
                users[email] = { password: users[email], data: {} };
            }
        });
        localStorage.setItem('users', JSON.stringify(users));
    } catch(e) { console.error(e); }
}
standardizeUsersFormat();

function saveUserData() {
    try {
        const currentUser = JSON.parse(localStorage.getItem('currentUser'));
        const users = JSON.parse(localStorage.getItem('users') || '{}');

        if (currentUser) {
            if (!currentUser.email) {
                currentUser.email = Object.keys(users).find(email => users[email].data === currentUser.data);
            }

            currentUser.data = {
                hourlyWage: hourlyWage,
                annualSalary: annualSalaryInput ? annualSalaryInput.value : '',
                weeklyHours: weeklyHoursInput ? weeklyHoursInput.value : '',
                hourlyWageInput: hourlyWageField ? hourlyWageField.value : '',
                wageToggle: wageToggle ? wageToggle.checked : false,
                turdTokens: turdTokens,
                lastAwardDate: lastAwardDate,
                poopLogData: poopLogData 
            };

            localStorage.setItem('currentUser', JSON.stringify(currentUser));

            if (currentUser.email && users[currentUser.email]) {
                users[currentUser.email].data = currentUser.data;
                localStorage.setItem('users', JSON.stringify(users));
            }
        }
    } catch (e) { console.error("Error saving", e); }
}

function renderPoopLogs(logsToRender = poopLogData) {
    const container = document.getElementById('poopLog');
    const placeholder = document.getElementById('poopLogPlaceholder');
    
    if(!container) return;

    container.innerHTML = '';
    
    if (logsToRender.length === 0) {
        if(placeholder) placeholder.style.display = 'block';
        return;
    } else {
        if(placeholder) placeholder.style.display = 'none';
    }

    const sortedLogs = [...logsToRender].sort((a, b) => new Date(b.date) - new Date(a.date));

    sortedLogs.forEach(log => {
        const logEntry = document.createElement('div');
        logEntry.className = 'log-entry';
        const ratingString = log.rating > 0 ? 'ðŸ’©'.repeat(log.rating) : 'Not rated';
        
        logEntry.innerHTML = `
            <button class="delete-button" onclick="confirmDelete(${log.id})">Ã—</button>
            <p class="log-date">${log.date}</p>
            <p class="log-duration">Duration: ${formatTime(log.durationSeconds)}</p>
            <p class="log-earnings">Earnings: $${log.earnings.toFixed(2)}</p>
            <p class="log-rating">Rating: <span class="rating-value">${ratingString}</span></p>
        `;
        container.appendChild(logEntry);
    });
}

function recalculateStatistics(logsToCalculate = poopLogData) {
    let newStats = {
        totalSessions: 0,
        totalPoopTime: 0,
        totalEarnings: 0,
        firstSessionDate: null,
        lastSessionDate: null
    };

    if (logsToCalculate.length > 0) {
        const dates = logsToCalculate.map(l => new Date(l.date));
        newStats.firstSessionDate = new Date(Math.min(...dates));
        newStats.lastSessionDate = new Date(Math.max(...dates));
        
        logsToCalculate.forEach(log => {
            newStats.totalSessions++;
            newStats.totalPoopTime += log.durationSeconds;
            newStats.totalEarnings += log.earnings;
        });
    }
    stats = newStats;
    displayStatistics();
}

function confirmDelete(id) {
    const confirmDialog = document.querySelector('.confirm-dialog');
    confirmDialog.style.display = 'block';

    const confirmButton = confirmDialog.querySelector('.confirm');
    const cancelButton = confirmDialog.querySelector('.cancel');

    const newConfirm = confirmButton.cloneNode(true);
    const newCancel = cancelButton.cloneNode(true);
    confirmButton.parentNode.replaceChild(newConfirm, confirmButton);
    cancelButton.parentNode.replaceChild(newCancel, cancelButton);

    newConfirm.addEventListener('click', () => {
        poopLogData = poopLogData.filter(log => log.id !== id);
        saveUserData();
        renderPoopLogs();
        recalculateStatistics();
        confirmDialog.style.display = 'none';
    });

    newCancel.addEventListener('click', () => {
        confirmDialog.style.display = 'none';
    });
}

function checkLoginStatus() {
    if (!localStorage.getItem('currentUser')) {
        window.location.href = '/index.html';
    }
}

function isFirstSessionOfDay() {
    const today = new Date().toDateString();
    const lastAwardDay = lastAwardDate ? new Date(lastAwardDate).toDateString() : null;

    if (today !== lastAwardDay) {
        lastAwardDate = new Date().toISOString();
        saveUserData();
        return true;
    }
    return false;
}

function showTokenAwardNotification() {
    const ratingsBox = document.querySelector('.ratings-box') || document.body;
    
    const notification = document.createElement('div');
    notification.className = 'token-award-notification';
    notification.textContent = 'ðŸŽ‰ You earned 1 Turd Token for your first poop of the day!';
    notification.style.position = 'fixed';
    notification.style.bottom = '20px';
    notification.style.left = '50%';
    notification.style.transform = 'translateX(-50%)';
    notification.style.backgroundColor = '#4CAF50';
    notification.style.color = 'white';
    notification.style.padding = '15px';
    notification.style.borderRadius = '5px';
    notification.style.zIndex = '2000';
    
    ratingsBox.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 3000);
}

function updateTurdTokenDisplay() {
    const tokenDisplay = document.querySelector('.turd-token-balance span');
    if (tokenDisplay) {
        tokenDisplay.textContent = `TT: ${turdTokens}`;
    }
    localStorage.setItem('turdTokens', turdTokens);
}

function displayStatistics() {
    const totalTime = stats.totalPoopTime;
    const totalHours = Math.floor(totalTime / 3600);
    const totalMinutes = Math.floor((totalTime % 3600) / 60);
    const totalSecs = totalTime % 60;

    const avgPoopTime = stats.totalSessions > 0 ? totalTime / stats.totalSessions : 0;
    const avgHours = Math.floor(avgPoopTime / 3600);
    const avgMinutes = Math.floor((avgPoopTime % 3600) / 60);
    const avgSecs = Math.floor(avgPoopTime % 60);

    let totalDays = 1;
    if (stats.firstSessionDate && stats.lastSessionDate) {
        const timeDiff = Math.abs(stats.lastSessionDate - stats.firstSessionDate);
        totalDays = Math.max(1, Math.ceil(timeDiff / (1000 * 60 * 60 * 24)));
    }
    
    const avgPoopsPerDay = (stats.totalSessions / totalDays).toFixed(2);

    document.getElementById('totalSessions').textContent = stats.totalSessions;
    document.getElementById('totalTime').textContent = `${String(totalHours).padStart(2, '0')}:${String(totalMinutes).padStart(2, '0')}:${String(totalSecs).padStart(2, '0')}`;
    document.getElementById('totalEarnings').textContent = `$${stats.totalEarnings.toFixed(2)}`;
    document.getElementById('avgPoopTime').textContent = `${String(avgHours).padStart(2, '0')}:${String(avgMinutes).padStart(2, '0')}:${String(avgSecs).padStart(2, '0')}`;
    document.getElementById('avgEarnings').textContent = `$${(stats.totalSessions > 0 ? stats.totalEarnings / stats.totalSessions : 0).toFixed(2)}`;
    document.getElementById('avgPoopsPerDay').textContent = avgPoopsPerDay;

    updateStatsChart(stats);
}

function updateStatsChart(statsData) {
    const ctx = document.getElementById('statsChart')?.getContext('2d');
    if(!ctx) return;
    
    if (window.statsBarChart) {
        window.statsBarChart.destroy();
    }
    
    let chartTotalDays = 1;
    if (statsData.firstSessionDate && statsData.lastSessionDate) {
         chartTotalDays = Math.max(1, Math.ceil((statsData.lastSessionDate - statsData.firstSessionDate) / (1000 * 60 * 60 * 24)));
    }

    window.statsBarChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['Total Sessions', 'Avg Poops/Day', 'Total Hours', 'Avg Minutes/Poop', 'Total Earnings ($)'],
            datasets: [{
                label: 'Statistics',
                data: [
                    statsData.totalSessions,
                    parseFloat((statsData.totalSessions / chartTotalDays).toFixed(2)),
                    Math.floor(statsData.totalPoopTime / 3600),
                    Math.floor((statsData.totalPoopTime / statsData.totalSessions / 60) || 0),
                    parseFloat(statsData.totalEarnings.toFixed(2))
                ],
                backgroundColor: ['rgba(52, 152, 219, 0.6)', 'rgba(46, 204, 113, 0.6)', 'rgba(155, 89, 182, 0.6)', 'rgba(241, 196, 15, 0.6)', 'rgba(231, 76, 60, 0.6)'],
                borderColor: ['rgba(52, 152, 219, 1)', 'rgba(46, 204, 113, 1)', 'rgba(155, 89, 182, 1)', 'rgba(241, 196, 15, 1)', 'rgba(231, 76, 60, 1)'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: { beginAtZero: true, grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#f1f1f1' } },
                x: { grid: { color: 'rgba(255, 255, 255, 0.1)' }, ticks: { color: '#f1f1f1' } }
            },
            plugins: { legend: { display: false } }
        }
    });
}

function filterStatsByDateRange(startDate, endDate) {
    const start = new Date(startDate);
    start.setHours(0,0,0,0);
    
    const end = new Date(endDate);
    end.setHours(23,59,59,999);

    const filteredLogs = poopLogData.filter(log => {
        const logDate = new Date(log.date);
        return logDate >= start && logDate <= end;
    });

    renderPoopLogs(filteredLogs); 
    recalculateStatistics(filteredLogs); 
}

function clearActiveFilters() {
    document.getElementById('allTimeStats').classList.remove('active');
    document.getElementById('todayStats').classList.remove('active');
    document.getElementById('startDate').value = '';
    document.getElementById('endDate').value = '';
    
    renderPoopLogs(); 
    recalculateStatistics(); 
}

function validateInputs() {
    let isValid = true;
    if (wageToggle.checked) {
        if (!hourlyWageField.value) {
            document.getElementById('hourlyWageError').textContent = 'Please enter your hourly wage';
            document.getElementById('hourlyWageError').style.display = 'block';
            isValid = false;
        } else {
            document.getElementById('hourlyWageError').style.display = 'none';
        }
    } else {
        if (!annualSalaryInput.value) {
            document.getElementById('salaryError').textContent = 'Please enter your annual salary';
            document.getElementById('salaryError').style.display = 'block';
            isValid = false;
        } else {
            document.getElementById('salaryError').style.display = 'none';
        }
        if (!weeklyHoursInput.value) {
            document.getElementById('hoursError').textContent = 'Please enter your weekly work hours';
            document.getElementById('hoursError').style.display = 'block';
            isValid = false;
        } else {
            document.getElementById('hoursError').style.display = 'none';
        }
    }
    return isValid;
}

function startTimer() {
    // Force validation before starting
    if (!validateInputs()) {
        alert("Please fill in your salary information first!");
        return; 
    }
    const timerButton = document.getElementById('timerButton');
    const poopEmoji = document.querySelector('.poop-emoji');

    if (!isTimerRunning) {
        isTimerRunning = true;
        timerButton.textContent = 'Stop Pooping';
        poopEmoji.classList.add('wiggle');

        // Save start state
        localStorage.setItem('timerStart', Date.now());
        localStorage.setItem('isTimerRunning', true);

        if (isFirstSessionOfDay()) {
            turdTokens++; 
            updateTurdTokenDisplay(); 
            showTokenAwardNotification(); 
        }

        updateTimer();
    } else {
        // Stop the timer
        isTimerRunning = false;
        localStorage.removeItem('timerStart');
        localStorage.removeItem('isTimerRunning');

        timerButton.textContent = 'Start Pooping';
        poopEmoji.classList.remove('wiggle');
        openRatingModal(); 
    }
}

function updateTimer() {
    const startTime = parseInt(localStorage.getItem('timerStart'), 10);
    const isRunning = JSON.parse(localStorage.getItem('isTimerRunning'));
    
    if (!startTime || !isRunning) return;

    const timerDisplay = document.getElementById('timerDisplay');
    const earningsDisplay = document.getElementById('earningsDisplay');
    
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    // Update global seconds variable so saving works correctly
    window.seconds = elapsed;

    if(timerDisplay) timerDisplay.textContent = formatTime(elapsed);
    if(earningsDisplay) {
        const earnings = ((hourlyWage / 3600) * elapsed).toFixed(2);
        earningsDisplay.textContent = `Current earnings: $${earnings}`;
    }

    requestAnimationFrame(updateTimer);
}

document.addEventListener('DOMContentLoaded', () => {
    // Assignments
    annualSalaryInput = document.getElementById('annualSalary');
    weeklyHoursInput = document.getElementById('weeklyHours');
    wageToggle = document.getElementById('wageToggle');
    hourlyWageField = document.getElementById('hourlyWageField');
    hourlyWageDisplay = document.getElementById('hourlyWage');

    // Listeners
    if(annualSalaryInput) annualSalaryInput.addEventListener('input', updateHourlyWage);
    if(weeklyHoursInput) weeklyHoursInput.addEventListener('input', updateHourlyWage);
    if(hourlyWageField) hourlyWageField.addEventListener('input', updateHourlyWage);
    
    const allTimeStatsBtn = document.getElementById('allTimeStats');
    const todayStatsBtn = document.getElementById('todayStats');
    const startDateInput = document.getElementById('startDate');
    const endDateInput = document.getElementById('endDate');
    const filterButton = document.getElementById('filterStats');
    const resetButton = document.getElementById('resetStats');

    // Rating Modal Logic
    const ratingModal = document.getElementById('ratingModal');
    const submitRatingButton = document.getElementById('submitRatingButton');
    const poopEmojis = document.querySelectorAll('.poopEmoji');
    let selectedRating = 0;

    poopEmojis.forEach(emoji => {
        emoji.addEventListener('click', () => {
            selectedRating = parseInt(emoji.dataset.rating);
            poopEmojis.forEach((e, index) => {
                e.style.opacity = index < selectedRating ? '1' : '0.5';
            });
        });
    });

    submitRatingButton.addEventListener('click', () => {
        if (selectedRating > 0 && poopLogData.length > 0) {
            poopLogData[0].rating = selectedRating;
            saveUserData();
            renderPoopLogs();
            
            const latestLog = poopLogData[0];
            openShareModal(latestLog.earnings.toFixed(2), selectedRating);
        }
        ratingModal.style.display = 'none';
    });

    // Timer Button Logic
    const timerButton = document.getElementById('timerButton');
    if(timerButton) timerButton.addEventListener('click', startTimer);

    // Wage Toggle Logic
    if(wageToggle) {
        wageToggle.addEventListener('change', function() {
            const hourlyInputDiv = document.getElementById('hourlyWageInput');
            const salaryInputDiv = document.getElementById('salaryHoursInputs');
            const label = document.getElementById('toggleLabel');
            
            if (this.checked) {
                if(salaryInputDiv) salaryInputDiv.style.display = 'none';
                if(hourlyInputDiv) hourlyInputDiv.style.display = 'block';
                if(label) label.textContent = 'Hourly Wage';
            } else {
                if(salaryInputDiv) salaryInputDiv.style.display = 'block';
                if(hourlyInputDiv) hourlyInputDiv.style.display = 'none';
                if(label) label.textContent = 'Salary & Hours';
            }
            updateHourlyWage();
        });
    }

    // Resume Timer if needed
    if (localStorage.getItem('isTimerRunning')) {
        isTimerRunning = true;
        if(timerButton) {
            timerButton.textContent = 'Stop Pooping';
            const emoji = document.querySelector('.poop-emoji');
            if(emoji) emoji.classList.add('wiggle');
        }
        updateTimer();
    }

    // Stats Filtering
    if(todayStatsBtn) todayStatsBtn.addEventListener('click', () => {
        clearActiveFilters();
        todayStatsBtn.classList.add('active');
        filterStatsByDay(new Date());
    });

    if(allTimeStatsBtn) allTimeStatsBtn.addEventListener('click', () => {
        clearActiveFilters();
        allTimeStatsBtn.classList.add('active');
    });

    if(filterButton) filterButton.addEventListener('click', () => {
        if (startDateInput.value && endDateInput.value) {
            filterStatsByDateRange(startDateInput.value, endDateInput.value);
        } else {
            alert('Please select both start and end dates.');
        }
    });

    if(resetButton) resetButton.addEventListener('click', clearActiveFilters);

    // Tabs
    const tabs = document.querySelectorAll('.tab');
    const tabContents = document.querySelectorAll('.tab-content');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            const activeContent = document.querySelector('.tab-content.active');
            const newContent = document.getElementById(`${tabId}Tab`);

            if(activeContent) activeContent.classList.add('fade-out');

            setTimeout(() => {
                tabs.forEach(t => t.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active', 'fade-out'));
                tab.classList.add('active');
                newContent.classList.add('active', 'fade-out');
                void newContent.offsetWidth;
                newContent.classList.remove('fade-out');
            }, 300); 
        });
    });

    // Wallet Modal
    const turdTokenBalance = document.getElementById('turdTokenBalance');
    const turdTokenWallet = document.getElementById('turdTokenWallet');
    if(turdTokenBalance && turdTokenWallet) {
        turdTokenBalance.addEventListener('click', () => {
            turdTokenWallet.style.display = 'block';
            const wb = document.getElementById('walletBalance');
            if(wb) wb.textContent = turdTokens;
        });
        
        turdTokenWallet.querySelector('.close').addEventListener('click', () => {
            turdTokenWallet.style.display = 'none';
        });
    }

    // Global Click Handler for Modals
    window.onclick = function(event) {
        if (event.target == ratingModal) ratingModal.style.display = "none";
        if (event.target == document.getElementById('shareModal')) document.getElementById('shareModal').style.display = 'none';
        if (event.target == turdTokenWallet) turdTokenWallet.style.display = 'none';
        if (event.target == document.querySelector('.confirm-dialog')) document.querySelector('.confirm-dialog').style.display = 'none';
    }

    checkLoginStatus();
    loadUserData();
    updateHourlyWage();
});

function filterStatsByDay(date) {
    const startOfDay = new Date(date);
    startOfDay.setHours(0, 0, 0, 0);
    const endOfDay = new Date(date);
    endOfDay.setHours(23, 59, 59, 999);
    filterStatsByDateRange(startOfDay, endOfDay);
}

function openShareModal(earnings, rating) {
    const ratingText = rating > 0 ? 'ðŸ’©'.repeat(rating) : '';
    const message = `I just had a ${ratingText}-poop and earned $${earnings}! Find out how much you make to poop at www.poopprofit.com!`;
    const shareModal = document.getElementById('shareModal');
    if(shareModal) shareModal.style.display = 'block';

    document.getElementById('twitterShareButton').onclick = () => {
        window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}`, '_blank');
    };
    document.getElementById('facebookShareButton').onclick = () => {
        window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('https://www.poopprofit.com')}&quote=${encodeURIComponent(message)}`, '_blank');
    };
    document.getElementById('smsShareButton').onclick = () => {
        window.open(`sms:?&body=${encodeURIComponent(message)}`);
    };
}

function shareStatisticsOnTwitter() {
    window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(getShareableStats())}`, '_blank');
}
function shareStatisticsOnFacebook() {
    window.open(`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent('https://www.poopprofit.com')}&quote=${encodeURIComponent(getShareableStats())}`, '_blank');
}
function shareStatisticsViaSMS() {
    window.open(`sms:?&body=${encodeURIComponent(getShareableStats())}`);
}

function getShareableStats() {
    return `ðŸš½ My Poop Profit Stats:
Total Sessions: ${stats.totalSessions}
Total Earnings: $${stats.totalEarnings.toFixed(2)}
Average Per Session: $${(stats.totalEarnings / stats.totalSessions || 0).toFixed(2)}
Track your bathroom breaks at www.poopprofit.com!`;
}

function openRatingModal() {
    const ratingModal = document.getElementById('ratingModal');
    const congratsMessage = document.getElementById('congratsMessage');
    const poopEmojis = document.querySelectorAll('.poopEmoji');
    
    // Access global seconds which is updated by updateTimer
    const s = window.seconds || 0; 
    const earnings = parseFloat(((hourlyWage / 3600) * s).toFixed(2));
    
    if(congratsMessage) congratsMessage.textContent = `Congratulations! You just earned $${earnings.toFixed(2)}!`;
    if(ratingModal) ratingModal.style.display = 'block';
    
    // Reset rating selection
    if(poopEmojis) poopEmojis.forEach(emoji => emoji.style.opacity = '0.5');

    const newLog = {
        id: Date.now(),
        date: new Date().toLocaleString(),
        durationSeconds: s,
        earnings: earnings,
        rating: 0 
    };

    poopLogData.unshift(newLog);
    saveUserData();
    renderPoopLogs();
    recalculateStatistics();

    // Reset UI
    const timerDisplay = document.getElementById('timerDisplay');
    const earningsDisplay = document.getElementById('earningsDisplay');
    if(timerDisplay) timerDisplay.textContent = '00:00:00';
    if(earningsDisplay) earningsDisplay.textContent = '';
    window.seconds = 0;
}

// Games Popup Logic
function showPopup() {
    const gp = document.getElementById("gamesPopup");
    if(gp) gp.style.display = "flex";
}
function closePopup() {
    const gp = document.getElementById("gamesPopup");
    if(gp) gp.style.display = "none";
}
function logout() {
    localStorage.removeItem('currentUser');
    window.location.href = '/loggedout.html'; 
}
</script>
</body></html>
